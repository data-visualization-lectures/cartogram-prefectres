# プロジェクト状態の保存・読込機能 実装プラン

## 目的
現在の「読み込んだデータ（CSVなど）」と「設定（配色、表示モード、選択フィールドなど）」を一括して JSON ファイルとして保存し、後でそのファイルを読み込むことで作業状態を復元できるようにする。

## 変更内容

### 1. UIの変更 (`index.html`)

**保存ボタンの追加:**
- 「SVGダウンロード」「PNGダウンロード」の並びに「**プロジェクト保存** (JSON)」ボタンを追加します。
- これにより、現在のマップの状態をいつでも保存できるようになります。

**読込ボタンの追加:**
- 「データ管理」エリア（データアップロードタブ、またはその付近）に「**設定ファイル読込** (JSON)」ボタン（またはファイル入力エリア）を追加します。

### 2. ロジックの変更 (`assets/main.js`)

**A. データ構造の定義**
保存する JSON の構造を以下のように定めます：
```json
{
  "version": 1,
  "timestamp": "YYYY-MM-DDTHH:mm:ss.sssZ",
  "mapId": "japan_prefectures",
  "data": [ ... ], // 現在の rawData (CSVの中身)
  "settings": {
     "fieldKey": "population",      // 選択中の指標（列名）
     "colorSchemeId": "blues",      // 配色ID
     "legendCells": 5,              // 分割数
     "legendUnit": "人",             // 単位
     "displayMode": "value",        // 実数 or ランキング
     "showLabels": true             // ラベル表示有無
  }
}
```

**B. 保存機能 (`saveProjectState`)**
- 現在の変形状態のキーとなる変数 (`currentMap`, `rawData`, `field`, `currentColorScheme` 等) を収集。
- 上記 JSON 構造を作成し、Blob 化してダウンロードさせる。

**C. 読込機能 (`loadProjectState`)**
- JSONファイルを読み込みパースする。
- **マップの復元**: 
  - 保存された `mapId` が現在と異なる場合、地図（Topology）を再読み込みする。
  - 既存の `changeMap` 関数は、完了時にサンプルデータを自動適用する仕様のため、ここを改修する（コールバック時にデータ読込をスキップするオプション `skipData` を追加）。
- **データの復元**:
  - `loadDataset` を使用して保存された `data` を展開・検証する。
- **設定の復元**:
  - `fieldKey` に一致する列を選択。
  - 配色、分割数、単位、表示モードを再適用。
  - UIコントローラ（セレクトボックス等）の値を更新。
  - 最後に `update()` を呼び出して描画を更新する。

**D. `changeMap` のリファクタリング**
- `changeMap(mapId, options)` に、地図読み込み完了後のフック（`onMapLoaded` コールバック、または `options.skipData` フラグ）を追加し、状態復元時のデータ上書きを防ぐ。

## 実装ステップ

1. **`changeMap` の改修**: データ読み込みをスキップ可能にする。
2. **`saveProjectState` の実装**: 現在の状態をダンプする機能を作成。
3. **`loadProjectState` の実装**: JSONを受け取り、順序立てて状態を復元する機能を作成。
4. **UIへの組み込み**: `index.html` にボタンを配置し、イベントリスナーを設定。
5. **動作確認**:
   - データアップロード後に保存 → リセット → 読込で元に戻るか。
   - 別の地図を選択中に読込を行い、正しい地図に切り替わるか。
